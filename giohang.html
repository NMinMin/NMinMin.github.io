<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gi·ªè H√†ng</title>
  <link rel="stylesheet" href="./style/giohang.css">
  <link rel="icon" href="https://raw.githubusercontent.com/NMinMin/Image/refs/heads/main/z6593266591621_7e630df8aecd9967d6d82f116a73cbd1.jpg" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://smtpjs.com/v3/smtp.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

</head>
<body>
  <!-- Header Section -->
<header class="header">
    <div class="logo">C·ª≠a h√†ng ƒê·ªì ƒÉn & ƒê·ªì u·ªëng</div>
    <nav>
      <ul>
            <li style="margin-top: 4px;"><a href="trangchu.html">Trang Ch·ªß</a></li>
            <li style="margin-top: 4px;"><a href="sanpham.html">S·∫£n ph·∫©m</a></li>
            <li style="margin-top: 4px;"><a href="thanhvien.html">Th√†nh vi√™n</a></li>
            <li style="margin-top: 4px;"><a href="dangnhap_dangky.html">T√†i Kho·∫£n</a></li>
        <li style="margin-top: 4px;">
          <a href="giohang.html" id="cart-link">
            üõí Gi·ªè H√†ng <span id="cart-count">0</span>
          </a>
        </li>
        <li id="logout-link"  style="margin-top: 4px;"><a href="#">ƒêƒÉng xu·∫•t</a></li>
      </ul>
    </nav>
  </header>

  <!-- Gi·ªè H√†ng -->
  <section class="cart-section">
    <h2>Gi·ªè H√†ng c·ªßa b·∫°n</h2>
    <div id="cart-container" class="cart-container">
      <!-- C√°c s·∫£n ph·∫©m trong gi·ªè h√†ng s·∫Ω ƒë∆∞·ª£c JS ƒë·ªï v√†o ƒë√¢y -->
    </div>
    <div id="cart-items"></div>
    <b><p id="total"><strong>T·ªïng ti·ªÅn:</strong> 0 VND</p></b>


    <!-- Form th√¥ng tin ng∆∞·ªùi d√πng -->
    <form id="checkout-form" class="checkout-form">
      <h3>Th√¥ng tin giao h√†ng</h3>
      <input type="text" id="full-name" placeholder="H·ªç t√™n" required autocomplete="name">
      <input type="text" id="address" placeholder="ƒê·ªãa ch·ªâ" required autocomplete="street-address">
      <input type="tel" id="phone" placeholder="S·ªë ƒëi·ªán tho·∫°i" required autocomplete="tel">
      <button type="submit" onclick="">Thanh To√°n</button>
      <input type="hidden" name="order_list" id="order_list">
      <input type="hidden" name="total_price" id="total_price">

    </form>
  </section>
  <script>
const currentUser = JSON.parse(localStorage.getItem("currentUser"));
    document.addEventListener('DOMContentLoaded', function () {
        
        // Khai b√°o v√† kh·ªüi t·∫°o cart ngay t·ª´ ƒë·∫ßu
        let cart = JSON.parse(localStorage.getItem(`cart_${currentUser.email}`)) || [];
        const cartItemsContainer = document.getElementById('cart-items');
        const totalElement = document.getElementById('total');
        let totalPrice = 0;

        if (cart.length === 0) {
            cartItemsContainer.innerHTML = '<p>Gi·ªè h√†ng tr·ªëng.</p>';
        } else {
            cart.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'cart-item';
                itemDiv.innerHTML = `
                    <img src="${item.image}" alt="${item.name}" width="80">
                    <strong>${item.name}</strong>
                    <p>${item.price.toLocaleString()} VND</p>
                    <p>S·ªë l∆∞·ª£ng: ${item.quantity}</p>
                    <button class="delete-btn" data-id="${item.id}">X√≥a</button>
                    <hr/>
                `;
                totalPrice += item.price * item.quantity;
                cartItemsContainer.appendChild(itemDiv);
            });
            totalElement.innerText = `T·ªïng ti·ªÅn: ${totalPrice.toLocaleString()} VND`;
        }

        // X·ª≠ l√Ω n√∫t X√≥a
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', function () {
                const id = this.getAttribute('data-id');
                cart = cart.filter(i => i.id !== id);
                localStorage.setItem(`cart_${currentUser.email}`, JSON.stringify(cart));
                location.reload();
            });
        });

        // Kh·ªüi t·∫°o EmailJS
        emailjs.init("E8gbkv5o0LLKhagKs");

        document.getElementById('checkout-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const fullName = document.getElementById('full-name').value;
            const address = document.getElementById('address').value;
            const phone = document.getElementById('phone').value;

            if (!currentUser) {
                alert('B·∫°n ph·∫£i ƒëƒÉng nh·∫≠p tr∆∞·ªõc.');
                return;
            }

            const orders = cart.map(item => ({
            name: item.name,
            units: item.quantity,
            price: (item.price * item.quantity).toLocaleString() + ' VND'
        }));



            const params = {
                email: currentUser.email,
                full_name: fullName,
                address: address,
                phone: phone,
                orders: orders,
                total_price: totalPrice.toLocaleString() + ' VND'
            };
            console.log("üìß Sending email with params: ", params);

            emailjs.send("service_nzpo11o", "template_09w8vhh", params)
                .then(res => {
                    console.log("‚úÖ Email sent", res.status, res.text);
                    alert("ƒê√£ g·ª≠i email x√°c nh·∫≠n ƒë∆°n h√†ng.");
                    localStorage.removeItem(`cart_${currentUser.email}`);
                    location.reload();
                })
                .catch(err => {
                    console.error("‚ùå Error sending email", err);
                    alert("L·ªói khi g·ª≠i email: " + err.text);
                });
        });
        const navLinks = document.querySelectorAll('header nav ul li a');

        if (currentUser) {
            navLinks.forEach(link => {
            if (link.getAttribute('href') === '#account') {
                link.textContent = `Xin ch√†o, ${currentUser.name}`;
            }
            });

            // üëâ Load cart c·ªßa user t·ª´ localStorage
            const savedCart = localStorage.getItem(`cart_${currentUser.email}`);
            cart = savedCart ? JSON.parse(savedCart) : [];
            updateCartCount();
        }
        const logoutLink = document.getElementById('logout-link');
        if (logoutLink) {
            logoutLink.addEventListener('click', () => {
                localStorage.removeItem('currentUser');
                alert('ƒê√£ ƒëƒÉng xu·∫•t.');
                window.location.href = 'dangnhap_dangky.html'; // Chuy·ªÉn v·ªÅ trang ch·ªß sau khi ƒëƒÉng xu·∫•t
            });
        }

        const accountLink = document.getElementById('account-link');
        if (accountLink) {
            accountLink.addEventListener('click', () => {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (!currentUser) {
                    window.location.href = 'dangnhap_dangky.html'; // Chuy·ªÉn ƒë·∫øn trang ƒëƒÉng nh·∫≠p n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
                } else {
                    alert(`B·∫°n ƒëang ƒëƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n: ${currentUser.name}`);
                    // B·∫°n c√≥ th·ªÉ th√™m h√†nh ƒë·ªông kh√°c n·∫øu ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p
                }
            });
        }
    });

function formatCurrency(amount) {
    return amount.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
}

function removeFromCart(productId) {
    let cart = JSON.parse(localStorage.getItem(`cart_${currentUser.email}`)) || [];
    cart = cart.filter(item => item.id !== productId);
    localStorage.setItem(`cart_${currentUser.email}`, JSON.stringify(cart));
    renderCart(); // C·∫≠p nh·∫≠t l·∫°i giao di·ªán gi·ªè h√†ng (h√†m n√†y c√≥ th·ªÉ kh√¥ng t·ªìn t·∫°i)
}
    </script>
</body>
</html>
